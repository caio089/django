<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Dojoon</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .metric-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .revenue-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .users-card {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .growth-card {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="gradient-bg text-white p-6 shadow-lg">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">🥋 Dashboard Dojoon</h1>
                    <p class="text-blue-100 mt-2">Painel Administrativo - Assinaturas Premium</p>
                </div>
                <div class="text-right">
                    <p class="text-blue-100 mb-2">👤 Logado como: <strong>{{ request.user.username }}</strong></p>
                    <p class="text-blue-100 text-sm mb-3">Atualizado em: {{ current_date }}</p>
                    <div class="flex gap-3 justify-end">
                        <button onclick="refreshDashboardCache()" class="bg-blue-500/90 hover:bg-blue-600 px-5 py-3 rounded-xl transition-all duration-300 inline-block text-sm font-semibold shadow-lg hover:shadow-xl border-2 border-blue-400/50 hover:border-blue-300 transform hover:scale-105 active:scale-95 backdrop-blur-sm">
                            🔄 Atualizar
                        </button>
                        <button onclick="debugSubscriptions()" class="bg-purple-500/90 hover:bg-purple-600 px-5 py-3 rounded-xl transition-all duration-300 inline-block text-sm font-semibold shadow-lg hover:shadow-xl border-2 border-purple-400/50 hover:border-purple-300 transform hover:scale-105 active:scale-95 backdrop-blur-sm">
                            🔍 Debug
                        </button>
                        <button onclick="debugUsuarioEspecifico()" class="bg-orange-500/90 hover:bg-orange-600 px-5 py-3 rounded-xl transition-all duration-300 inline-block text-sm font-semibold shadow-lg hover:shadow-xl border-2 border-orange-400/50 hover:border-orange-300 transform hover:scale-105 active:scale-95 backdrop-blur-sm">
                            👤 Debug Usuário
                        </button>
                        <button onclick="ativarAssinaturaManual()" class="bg-green-500/90 hover:bg-green-600 px-5 py-3 rounded-xl transition-all duration-300 inline-block text-sm font-semibold shadow-lg hover:shadow-xl border-2 border-green-400/50 hover:border-green-300 transform hover:scale-105 active:scale-95 backdrop-blur-sm">
                            ✅ Ativar Premium
                        </button>
                        <button onclick="corrigirAssinaturas()" class="bg-yellow-500/90 hover:bg-yellow-600 px-5 py-3 rounded-xl transition-all duration-300 inline-block text-sm font-semibold shadow-lg hover:shadow-xl border-2 border-yellow-400/50 hover:border-yellow-300 transform hover:scale-105 active:scale-95 backdrop-blur-sm">
                            🔧 Corrigir Assinaturas
                        </button>
                        <a href="/admin/" class="bg-white/25 hover:bg-white/40 px-5 py-3 rounded-xl transition-all duration-300 inline-block text-sm font-semibold shadow-lg hover:shadow-xl border-2 border-white/30 hover:border-white/50 transform hover:scale-105 active:scale-95 backdrop-blur-sm">
                            🔧 Admin Django
                        </a>
                        <a href="{% url 'admin_logout' %}" class="bg-red-500/90 hover:bg-red-600 px-5 py-3 rounded-xl transition-all duration-300 inline-block text-sm font-bold shadow-lg hover:shadow-xl border-2 border-red-400/50 hover:border-red-300 transform hover:scale-105 active:scale-95 backdrop-blur-sm">
                            🚪 Sair
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto p-6">
        <!-- Cards Principais -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            
            <!-- Total de Usuários no Sistema -->
            <div class="card-hover metric-card rounded-2xl p-6 text-white shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm">Usuários no Sistema</p>
                        <p class="text-3xl font-bold">{{ total_users }}</p>
                    </div>
                    <div class="text-4xl">👥</div>
                </div>
            </div>

            <!-- Usuários Premium Únicos -->
            <div class="card-hover users-card rounded-2xl p-6 text-white shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm">Usuários Premium</p>
                        <p class="text-3xl font-bold">{{ unique_premium_users }}</p>
                    </div>
                    <div class="text-4xl">⭐</div>
                </div>
            </div>

            <!-- Receita Total -->
            <div class="card-hover revenue-card rounded-2xl p-6 text-white shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm">Receita Total</p>
                        <p class="text-3xl font-bold">R$ {{ total_revenue|floatformat:2 }}</p>
                    </div>
                    <div class="text-4xl">💰</div>
                </div>
            </div>

            <!-- Receita Este Mês -->
            <div class="card-hover growth-card rounded-2xl p-6 text-white shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm">Receita Este Mês</p>
                        <p class="text-3xl font-bold">R$ {{ current_month_revenue|floatformat:2 }}</p>
                    </div>
                    <div class="text-4xl">📈</div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            
            <!-- Gráfico de Receita Mensal -->
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4">📊 Receita Mensal (12 meses)</h3>
                <canvas id="revenueChart" width="400" height="200"></canvas>
            </div>

            <!-- Gráfico de Assinaturas -->
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4">📈 Novas Assinaturas (12 meses)</h3>
                <canvas id="subscriptionsChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Estatísticas Detalhadas -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            
            <!-- Comparação Mensal -->
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4">📊 Comparação Mensal</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg">
                        <span class="text-gray-700">Receita Este Mês:</span>
                        <span class="font-bold text-green-600">R$ {{ current_month_revenue|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg">
                        <span class="text-gray-700">Receita Mês Passado:</span>
                        <span class="font-bold text-blue-600">R$ {{ last_month_revenue|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-purple-50 rounded-lg">
                        <span class="text-gray-700">Novos Premium Este Mês:</span>
                        <span class="font-bold text-purple-600">{{ new_premium_this_month }}</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-orange-50 rounded-lg">
                        <span class="text-gray-700">Novos Premium Mês Passado:</span>
                        <span class="font-bold text-orange-600">{{ new_premium_last_month }}</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-red-50 rounded-lg">
                        <span class="text-gray-700">Crescimento:</span>
                        <span class="font-bold {% if growth_percentage >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if growth_percentage >= 0 %}+{% endif %}{{ growth_percentage }}%
                        </span>
                    </div>
                </div>
            </div>

            <!-- Status das Assinaturas -->
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4">🎯 Status das Assinaturas</h3>
                <div class="space-y-3">
                    {% for status in status_counts %}
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-700 capitalize">{{ status.status|default:"Sem Status" }}:</span>
                        <span class="font-bold text-gray-800">{{ status.count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Estatísticas de Usuários -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Card Total Usuários -->
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4">👤 Estatísticas de Usuários</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg">
                        <span class="text-gray-700 font-semibold">Total de Usuários:</span>
                        <span class="font-bold text-blue-600 text-2xl">{{ total_users }}</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg">
                        <span class="text-gray-700 font-semibold">Novos Este Mês:</span>
                        <span class="font-bold text-green-600 text-2xl">{{ users_this_month }}</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-purple-50 rounded-lg">
                        <span class="text-gray-700 font-semibold">Usuários Premium:</span>
                        <span class="font-bold text-purple-600 text-2xl">{{ unique_premium_users }}</span>
                    </div>
                </div>
            </div>

            <!-- Atribuir Premium -->
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4">⭐ Atribuir Plano Premium</h3>
                
                {% if messages %}
                    {% for message in messages %}
                    <div class="mb-4 p-3 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                        {{ message }}
                    </div>
                    {% endfor %}
                {% endif %}

                <form method="POST" action="{% url 'give_premium' %}" class="space-y-4">
                    {% csrf_token %}
                    
                    <!-- Opção 1: Digitar Email -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">📧 Email do Usuário:</label>
                        <input type="email" id="user_email" name="user_email" placeholder="Digite o email do usuário" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" />
                        <p class="text-sm text-gray-500 mt-1">Digite o email exato do usuário que você quer dar premium</p>
                    </div>
                    
                    <!-- Divisor -->
                    <div class="flex items-center my-4">
                        <div class="flex-1 border-t border-gray-300"></div>
                        <span class="px-3 text-gray-500 text-sm">OU</span>
                        <div class="flex-1 border-t border-gray-300"></div>
                    </div>
                    
                    <!-- Opção 2: Selecionar da Lista -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">👤 Selecionar da Lista:</label>
                        <select id="user_id" name="user_id" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">-- Escolha um usuário da lista --</option>
                            {% for user in recent_users %}
                            <option value="{{ user.id }}">{{ user.username }} - {{ user.email }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Selecione o Plano:</label>
                        <select name="plan_id" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">-- Escolha um plano --</option>
                            {% for plan in available_plans %}
                            <option value="{{ plan.id }}">{{ plan.nome }} - R$ {{ plan.preco }} ({{ plan.duracao_dias }} dias)</option>
                            {% endfor %}
                        </select>
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-purple-700 hover:from-purple-600 hover:to-purple-800 text-white font-bold py-3 px-6 rounded-lg transition-all">
                        ⭐ Atribuir Premium
                    </button>
                </form>
            </div>
        </div>

        <!-- Todos os Usuários -->
        <div class="bg-white rounded-2xl p-6 shadow-lg mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">👥 Todos os Usuários (Últimos 20)</h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-3 px-4">ID</th>
                            <th class="text-left py-3 px-4">Usuário</th>
                            <th class="text-left py-3 px-4">Email</th>
                            <th class="text-left py-3 px-4">Data Cadastro</th>
                            <th class="text-left py-3 px-4">Status</th>
                            <th class="text-center py-3 px-4">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in recent_users %}
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4 font-mono text-sm">{{ user.id }}</td>
                            <td class="py-3 px-4 font-bold">{{ user.username }}</td>
                            <td class="py-3 px-4">{{ user.email|default:"Sem email" }}</td>
                            <td class="py-3 px-4 text-gray-600">{{ user.date_joined|date:"d/m/Y H:i" }}</td>
                            <td class="py-3 px-4">
                                {% if user.has_active_subscription %}
                                    <span class="px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800">
                                        Premium ⭐
                                    </span>
                                {% else %}
                                    <span class="px-2 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-800">
                                        Gratuito
                                    </span>
                                {% endif %}
                            </td>
                            <td class="py-3 px-4">
                                <div class="flex gap-2 justify-center">
                                    <!-- Botão Remover Premium -->
                                    {% if user.has_active_subscription %}
                                    <form method="post" action="{% url 'remove_premium' %}" class="inline" onsubmit="return confirm('Tem certeza que deseja remover o premium de {{ user.username }}?');">
                                        {% csrf_token %}
                                        <input type="hidden" name="user_id" value="{{ user.id }}">
                                        <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white text-xs font-bold py-1 px-3 rounded transition-colors" title="Remover Premium">
                                            ❌ Premium
                                        </button>
                                    </form>
                                    {% endif %}
                                    
                                    <!-- Botão Excluir Conta -->
                                    {% if not user.is_superuser %}
                                    <button onclick="openDeleteModal({{ user.id }}, '{{ user.username }}', '{{ user.email }}')" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded transition-colors" title="Excluir Conta">
                                        🗑️ Excluir
                                    </button>
                                    {% else %}
                                    <span class="text-xs text-gray-400 italic">Admin</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="py-8 text-center text-gray-500">Nenhum usuário encontrado</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Modal de Confirmação para Excluir Usuário -->
        <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">⚠️</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Excluir Usuário</h3>
                    <p class="text-gray-600">Esta ação é <span class="font-bold text-red-600">IRREVERSÍVEL</span>!</p>
                </div>
                
                <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                    <p class="text-sm text-red-800">
                        <strong>Usuário:</strong> <span id="deleteUsername"></span><br>
                        <strong>Email:</strong> <span id="deleteEmail"></span>
                    </p>
                </div>
                
                <form method="post" action="{% url 'delete_user' %}" id="deleteForm" onsubmit="showDeleteLoading()">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" id="deleteUserId">
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">
                            Digite <span class="text-red-600 font-bold">"excluir"</span> para confirmar:
                        </label>
                        <input type="text" name="confirm" required 
                               class="w-full p-3 border-2 border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                               placeholder="Digite: excluir"
                               autocomplete="off"
                               id="confirmInput"
                               oninput="validateConfirmInput()">
                    </div>
                    
                    <!-- Loading State -->
                    <div id="deleteLoading" class="hidden mb-6">
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                            <div class="flex items-center">
                                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-3"></div>
                                <p class="text-blue-800 font-semibold">Excluindo usuário... Aguarde...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3" id="deleteButtons">
                        <button type="button" onclick="closeDeleteModal()" 
                                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" id="deleteSubmitBtn"
                                class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            🗑️ Excluir
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Assinaturas Recentes -->
        <div class="bg-white rounded-2xl p-6 shadow-lg">
            <h3 class="text-xl font-bold text-gray-800 mb-4">🕒 Assinaturas Recentes</h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-3 px-4">Usuário</th>
                            <th class="text-left py-3 px-4">Valor</th>
                            <th class="text-left py-3 px-4">Status</th>
                            <th class="text-left py-3 px-4">Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for subscription in recent_subscriptions %}
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4">
                                {% if subscription.usuario %}
                                    {{ subscription.usuario.username }}
                                {% else %}
                                    Usuário não encontrado
                                {% endif %}
                            </td>
                            <td class="py-3 px-4 font-bold text-green-600">{{ subscription.plano.nome }} - R$ {{ subscription.plano.preco|floatformat:2 }}</td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 rounded-full text-xs font-bold
                                    {% if subscription.status == 'ativa' %}bg-green-100 text-green-800
                                    {% elif subscription.status == 'suspensa' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ subscription.status|default:"N/A" }}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-gray-600">{{ subscription.data_criacao|date:"d/m/Y H:i" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="py-8 text-center text-gray-500">Nenhuma assinatura encontrada</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Gráfico de Receita
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        const revenueData = JSON.parse('{{ monthly_data_json|escapejs }}');
        
        new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: revenueData.map(item => item.month_name),
                datasets: [{
                    label: 'Receita (R$)',
                    data: revenueData.map(item => item.revenue),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });

        // Gráfico de Assinaturas
        const subscriptionsCtx = document.getElementById('subscriptionsChart').getContext('2d');
        
        new Chart(subscriptionsCtx, {
            type: 'bar',
            data: {
                labels: revenueData.map(item => item.month_name),
                datasets: [{
                    label: 'Novas Assinaturas',
                    data: revenueData.map(item => item.subscriptions),
                    backgroundColor: 'rgba(153, 102, 255, 0.8)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    </script>
    
    <!-- Script para Modal de Exclusão -->
    <script>
        function openDeleteModal(userId, username, email) {
            document.getElementById('deleteUserId').value = userId;
            document.getElementById('deleteUsername').textContent = username;
            document.getElementById('deleteEmail').textContent = email;
            document.getElementById('deleteModal').classList.remove('hidden');
            document.getElementById('deleteModal').classList.add('flex');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            document.getElementById('deleteModal').classList.remove('flex');
            document.getElementById('deleteForm').reset();
            resetDeleteModal(); // Resetar estado do modal
        }
        
        // Fechar modal ao clicar fora
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });
        
        // Função para mostrar loading durante exclusão
        function showDeleteLoading() {
            const loadingDiv = document.getElementById('deleteLoading');
            const buttonsDiv = document.getElementById('deleteButtons');
            const submitBtn = document.getElementById('deleteSubmitBtn');
            const confirmInput = document.getElementById('confirmInput');
            
            // Debug do valor ANTES de desabilitar
            console.log('DEBUG JS: Valor original:', confirmInput.value);
            console.log('DEBUG JS: Valor limpo:', confirmInput.value.toLowerCase().replace(/[^\w]/g, ''));
            console.log('DEBUG JS: Campo disabled antes:', confirmInput.disabled);
            
            // NÃO desabilitar o campo - isso impede o envio!
            // confirmInput.disabled = true;
            
            // Mostrar loading e esconder botões
            loadingDiv.classList.remove('hidden');
            buttonsDiv.classList.add('hidden');
            submitBtn.disabled = true;
            
            return true; // Permite o envio do formulário
        }
        
        // Função para resetar modal quando fechado
        function resetDeleteModal() {
            const loadingDiv = document.getElementById('deleteLoading');
            const buttonsDiv = document.getElementById('deleteButtons');
            const submitBtn = document.getElementById('deleteSubmitBtn');
            const confirmInput = document.getElementById('confirmInput');
            
            loadingDiv.classList.add('hidden');
            buttonsDiv.classList.remove('hidden');
            submitBtn.disabled = false;
            // confirmInput.disabled = false; // Não precisa desabilitar
            confirmInput.value = '';
            
            // Resetar estilos do input
            confirmInput.classList.remove('border-red-500', 'ring-2', 'ring-red-500', 'border-green-500');
            confirmInput.classList.add('border-red-300');
        }
        
        // Função para validar input em tempo real
        function validateConfirmInput() {
            const confirmInput = document.getElementById('confirmInput');
            const confirmValue = confirmInput.value.toLowerCase().replace(/[^\w]/g, '');
            
            // Remover estilos anteriores
            confirmInput.classList.remove('border-red-500', 'ring-2', 'ring-red-500', 'border-green-500');
            
            if (confirmValue === 'excluir') {
                // Valor correto - destacar em verde
                confirmInput.classList.add('border-green-500', 'ring-2', 'ring-green-500');
            } else if (confirmValue.length > 0) {
                // Valor incorreto - destacar em vermelho
                confirmInput.classList.add('border-red-500', 'ring-2', 'ring-red-500');
            } else {
                // Campo vazio - estilo padrão
                confirmInput.classList.add('border-red-300');
            }
        }
        
        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDeleteModal();
            }
        });
        
        // Função para atualizar cache do dashboard
        function refreshDashboardCache() {
            const button = event.target;
            const originalText = button.textContent;
            
            // Mostrar loading
            button.disabled = true;
            button.textContent = '🔄 Atualizando...';
            
            fetch('{% url "refresh_dashboard_cache" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar sucesso
                    button.textContent = '✅ Atualizado!';
                    button.classList.remove('bg-blue-500/90', 'hover:bg-blue-600');
                    button.classList.add('bg-green-500/90', 'hover:bg-green-600');
                    
                    // Recarregar página após 1 segundo
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    // Mostrar erro
                    button.textContent = '❌ Erro';
                    button.classList.remove('bg-blue-500/90', 'hover:bg-blue-600');
                    button.classList.add('bg-red-500/90', 'hover:bg-red-600');
                    
                    // Restaurar botão após 2 segundos
                    setTimeout(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                        button.classList.remove('bg-red-500/90', 'hover:bg-red-600');
                        button.classList.add('bg-blue-500/90', 'hover:bg-blue-600');
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Erro ao atualizar cache:', error);
                button.textContent = '❌ Erro';
                button.classList.remove('bg-blue-500/90', 'hover:bg-blue-600');
                button.classList.add('bg-red-500/90', 'hover:bg-red-600');
                
                // Restaurar botão após 2 segundos
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                    button.classList.remove('bg-red-500/90', 'hover:bg-red-600');
                    button.classList.add('bg-blue-500/90', 'hover:bg-blue-600');
                }, 2000);
            });
        }
        
        // Função para debug das assinaturas
        function debugSubscriptions() {
            const button = event.target;
            const originalText = button.textContent;
            
            // Mostrar loading
            button.disabled = true;
            button.textContent = '🔍 Analisando...';
            
            fetch('{% url "debug_subscriptions" %}', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('🔍 DEBUG - Assinaturas encontradas:', data);
                    
                    // Mostrar no console e alert
                    let debugInfo = `Total de assinaturas: ${data.total_subscriptions}\n\n`;
                    data.subscriptions.forEach(sub => {
                        debugInfo += `ID: ${sub.id}\n`;
                        debugInfo += `Usuário: ${sub.usuario_username} (ID: ${sub.usuario_id})\n`;
                        debugInfo += `Plano: ${sub.plano_nome}\n`;
                        debugInfo += `Status: ${sub.status}\n`;
                        debugInfo += `Ativo: ${sub.ativo}\n`;
                        debugInfo += `Data Criação: ${sub.data_criacao}\n`;
                        debugInfo += `Data Início: ${sub.data_inicio}\n`;
                        debugInfo += `Data Vencimento: ${sub.data_vencimento}\n`;
                        debugInfo += '---\n';
                    });
                    
                    alert(debugInfo);
                    
                    // Mostrar sucesso
                    button.textContent = '✅ Debug OK';
                    button.classList.remove('bg-purple-500/90', 'hover:bg-purple-600');
                    button.classList.add('bg-green-500/90', 'hover:bg-green-600');
                    
                    // Restaurar botão após 2 segundos
                    setTimeout(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                        button.classList.remove('bg-green-500/90', 'hover:bg-green-600');
                        button.classList.add('bg-purple-500/90', 'hover:bg-purple-600');
                    }, 2000);
                } else {
                    // Mostrar erro
                    button.textContent = '❌ Erro';
                    button.classList.remove('bg-purple-500/90', 'hover:bg-purple-600');
                    button.classList.add('bg-red-500/90', 'hover:bg-red-600');
                    
                    // Restaurar botão após 2 segundos
                    setTimeout(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                        button.classList.remove('bg-red-500/90', 'hover:bg-red-600');
                        button.classList.add('bg-purple-500/90', 'hover:bg-purple-600');
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Erro ao buscar assinaturas:', error);
                button.textContent = '❌ Erro';
                button.classList.remove('bg-purple-500/90', 'hover:bg-purple-600');
                button.classList.add('bg-red-500/90', 'hover:bg-red-600');
                
                // Restaurar botão após 2 segundos
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                    button.classList.remove('bg-red-500/90', 'hover:bg-red-600');
                    button.classList.add('bg-purple-500/90', 'hover:bg-purple-600');
                }, 2000);
            });
        }
        
        function debugUsuarioEspecifico() {
            const email = prompt('Digite o email do usuário para debug:', 'gregoriobaldocs@gmail.com');
            if (!email) return;
            
            const button = event.target;
            const originalText = button.textContent;
            
            // Mostrar loading
            button.disabled = true;
            button.textContent = '👤 Analisando...';
            
            fetch(`/dashboard/debug-usuario/?email=${encodeURIComponent(email)}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('DEBUG - Usuário específico:', data);
                console.log('DEBUG - Tipo de data:', typeof data);
                console.log('DEBUG - data.success:', data.success);
                console.log('DEBUG - data.usuario:', data.usuario);
                console.log('DEBUG - data.pagamentos:', data.pagamentos);
                console.log('DEBUG - data.assinaturas:', data.assinaturas);
                
                if (data.success) {
                    let debugInfo = `🔍 DEBUG DO USUÁRIO: ${data.usuario ? data.usuario.username : 'N/A'}\n`;
                    debugInfo += `📧 Email: ${data.usuario ? data.usuario.email : 'N/A'}\n`;
                    debugInfo += `🆔 ID: ${data.usuario ? data.usuario.id : 'N/A'}\n`;
                    debugInfo += `⭐ Conta Premium: ${data.usuario && data.usuario.conta_premium ? 'SIM' : 'NÃO'}\n`;
                    debugInfo += `📅 Data Vencimento: ${data.usuario && data.usuario.data_vencimento_premium ? data.usuario.data_vencimento_premium : 'N/A'}\n\n`;
                    
                    // Verificar se pagamentos existe e é array
                    const pagamentos = data.pagamentos || [];
                    debugInfo += `📊 PAGAMENTOS (${pagamentos.length}):\n`;
                    if (Array.isArray(pagamentos)) {
                        pagamentos.forEach((p, index) => {
                            debugInfo += `${index + 1}. ID: ${p.id}, Status: ${p.status}, Valor: R$ ${p.valor}\n`;
                            debugInfo += `   Data: ${p.data_criacao}\n`;
                            debugInfo += `   External Ref: ${p.external_reference}\n`;
                            debugInfo += `   Payment ID: ${p.payment_id}\n---\n`;
                        });
                    } else {
                        debugInfo += `   Erro: dados de pagamentos não são um array\n`;
                    }
                    
                    // Verificar se assinaturas existe e é array
                    const assinaturas = data.assinaturas || [];
                    debugInfo += `\n📊 ASSINATURAS (${assinaturas.length}):\n`;
                    if (Array.isArray(assinaturas)) {
                        assinaturas.forEach((a, index) => {
                            debugInfo += `${index + 1}. ID: ${a.id}, Status: ${a.status}, Ativo: ${a.ativo}\n`;
                            debugInfo += `   Plano: ${a.plano || 'N/A'}\n`;
                            debugInfo += `   Início: ${a.data_inicio}\n`;
                            debugInfo += `   Vencimento: ${a.data_vencimento}\n`;
                            debugInfo += `   External Ref: ${a.external_reference}\n---\n`;
                        });
                    } else {
                        debugInfo += `   Erro: dados de assinaturas não são um array\n`;
                    }
                    
                    alert(debugInfo);
                    
                    // Mostrar sucesso
                    button.textContent = '✅ Debug OK';
                    button.classList.remove('bg-orange-500/90', 'hover:bg-orange-600');
                    button.classList.add('bg-green-500/90', 'hover:bg-green-600');
                } else {
                    // Mostrar erro
                    button.textContent = '❌ Erro';
                    button.classList.remove('bg-orange-500/90', 'hover:bg-orange-600');
                    button.classList.add('bg-red-500/90', 'hover:bg-red-600');
                    alert('Erro: ' + data.message);
                }
                
                // Restaurar botão após 2 segundos
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                    button.classList.remove('bg-green-500/90', 'hover:bg-green-600', 'bg-red-500/90', 'hover:bg-red-600');
                    button.classList.add('bg-orange-500/90', 'hover:bg-orange-600');
                }, 2000);
            })
            .catch(error => {
                console.error('Erro ao buscar dados do usuário:', error);
                button.textContent = '❌ Erro';
                button.classList.remove('bg-orange-500/90', 'hover:bg-orange-600');
                button.classList.add('bg-red-500/90', 'hover:bg-red-600');
                
                // Restaurar botão após 2 segundos
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                    button.classList.remove('bg-red-500/90', 'hover:bg-red-600');
                    button.classList.add('bg-orange-500/90', 'hover:bg-orange-600');
                }, 2000);
            });
        }
        
        function ativarAssinaturaManual() {
            const email = prompt('Digite o email do usuário para ativar premium:', 'gregoriobaldocs@gmail.com');
            if (!email) return;
            
            if (!confirm(`Tem certeza que deseja ativar o premium para ${email}?`)) return;
            
            const button = event.target;
            const originalText = button.textContent;
            
            // Mostrar loading
            button.disabled = true;
            button.textContent = '⏳ Ativando...';
            
            fetch(`/dashboard/ativar-assinatura-manual/?email=${encodeURIComponent(email)}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Ativação manual:', data);
                
                if (data.success) {
                    alert(`✅ ${data.message}\n\nPlano: ${data.plano}\nVencimento: ${new Date(data.data_vencimento).toLocaleDateString('pt-BR')}`);
                    
                    // Mostrar sucesso
                    button.textContent = '✅ Ativado!';
                    button.classList.remove('bg-green-500/90', 'hover:bg-green-600');
                    button.classList.add('bg-blue-500/90', 'hover:bg-blue-600');
                    
                    // Recarregar a página após 2 segundos
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    // Mostrar erro
                    button.textContent = '❌ Erro';
                    button.classList.remove('bg-green-500/90', 'hover:bg-green-600');
                    button.classList.add('bg-red-500/90', 'hover:bg-red-600');
                    alert('Erro: ' + data.message);
                }
                
                // Restaurar botão após 3 segundos
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                    button.classList.remove('bg-blue-500/90', 'hover:bg-blue-600', 'bg-red-500/90', 'hover:bg-red-600');
                    button.classList.add('bg-green-500/90', 'hover:bg-green-600');
                }, 3000);
            })
            .catch(error => {
                console.error('Erro ao ativar assinatura:', error);
                button.textContent = '❌ Erro';
                button.classList.remove('bg-green-500/90', 'hover:bg-green-600');
                button.classList.add('bg-red-500/90', 'hover:bg-red-600');
                
                // Restaurar botão após 3 segundos
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                    button.classList.remove('bg-red-500/90', 'hover:bg-red-600');
                    button.classList.add('bg-green-500/90', 'hover:bg-green-600');
                }, 3000);
            });
        }
        
        function corrigirAssinaturas() {
            if (!confirm('Tem certeza que deseja corrigir todas as assinaturas inativas? Esta ação irá ativar todas as assinaturas que estão com status="ativa" mas ativo=False.')) return;
            
            const button = event.target;
            const originalText = button.textContent;
            
            // Mostrar loading
            button.disabled = true;
            button.textContent = '⏳ Corrigindo...';
            
            fetch('/dashboard/corrigir-assinaturas/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Correção de assinaturas:', data);
                
                if (data.success) {
                    alert(`✅ ${data.message}\n\nAssinaturas corrigidas: ${data.assinaturas_corrigidas}`);
                    
                    // Mostrar sucesso
                    button.textContent = '✅ Corrigido!';
                    button.classList.remove('bg-yellow-500/90', 'hover:bg-yellow-600');
                    button.classList.add('bg-blue-500/90', 'hover:bg-blue-600');
                    
                    // Recarregar a página após 2 segundos
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    // Mostrar erro
                    button.textContent = '❌ Erro';
                    button.classList.remove('bg-yellow-500/90', 'hover:bg-yellow-600');
                    button.classList.add('bg-red-500/90', 'hover:bg-red-600');
                    alert('Erro: ' + data.message);
                }
                
                // Restaurar botão após 3 segundos
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                    button.classList.remove('bg-blue-500/90', 'hover:bg-blue-600', 'bg-red-500/90', 'hover:bg-red-600');
                    button.classList.add('bg-yellow-500/90', 'hover:bg-yellow-600');
                }, 3000);
            })
            .catch(error => {
                console.error('Erro ao corrigir assinaturas:', error);
                button.textContent = '❌ Erro';
                button.classList.remove('bg-yellow-500/90', 'hover:bg-yellow-600');
                button.classList.add('bg-red-500/90', 'hover:bg-red-600');
                
                // Restaurar botão após 3 segundos
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                    button.classList.remove('bg-red-500/90', 'hover:bg-red-600');
                    button.classList.add('bg-yellow-500/90', 'hover:bg-yellow-600');
                }, 3000);
            });
        }
        
        // Funcionalidade para alternar entre email e seleção de usuário
        document.addEventListener('DOMContentLoaded', function() {
            const emailInput = document.getElementById('user_email');
            const userSelect = document.getElementById('user_id');
            
            if (emailInput && userSelect) {
                // Limpar select quando digitar email
                emailInput.addEventListener('input', function() {
                    if (this.value.trim() !== '') {
                        userSelect.value = '';
                    }
                });
                
                // Limpar email quando selecionar usuário
                userSelect.addEventListener('change', function() {
                    if (this.value !== '') {
                        emailInput.value = '';
                    }
                });
                
                // Validação do formulário
                const form = document.querySelector('form[action*="give_premium"]');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        const emailValue = emailInput.value.trim();
                        const selectValue = userSelect.value;
                        
                        if (!emailValue && !selectValue) {
                            e.preventDefault();
                            alert('Por favor, digite um email ou selecione um usuário da lista.');
                            return false;
                        }
                        
                        if (emailValue && selectValue) {
                            e.preventDefault();
                            alert('Por favor, use apenas uma opção: email OU seleção da lista.');
                            return false;
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>
