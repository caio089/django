{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - Pagamento{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-2xl mx-auto px-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Finalizar Pagamento</h1>
            <p class="text-gray-600">Escolha sua forma de pagamento preferida</p>
        </div>

        <!-- Informa√ß√µes do Pagamento -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Resumo do Pagamento</h2>
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-gray-600">Plano:</span>
                    <span class="font-medium">{{ pagamento.descricao }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Valor:</span>
                    <span class="font-bold text-lg text-green-600">R$ {{ pagamento.valor|floatformat:2 }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Status:</span>
                    <span class="px-2 py-1 rounded-full text-xs font-medium
                        {% if pagamento.status == 'approved' %}bg-green-100 text-green-800
                        {% elif pagamento.status == 'pending' %}bg-yellow-100 text-yellow-800
                        {% elif pagamento.status == 'rejected' %}bg-red-100 text-red-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ pagamento.get_status_display }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Formul√°rio oculto com CSRF Token -->
        <form style="display: none;">
            {% csrf_token %}
        </form>
        
        <!-- Op√ß√µes de Pagamento -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">Forma de Pagamento</h2>
            
            <!-- PIX -->
            <div class="mb-6">
                <button id="pix-option" class="w-full p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors payment-option" data-type="pix">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <span class="text-2xl">üì±</span>
                            </div>
                            <div class="text-left">
                                <h3 class="font-semibold text-gray-800">PIX</h3>
                                <p class="text-sm text-gray-600">Pagamento instant√¢neo e seguro</p>
                            </div>
                        </div>
                        <div class="text-green-600 font-medium">R$ {{ pagamento.valor|floatformat:2 }}</div>
                    </div>
                </button>
            </div>

            <!-- Cart√£o de Cr√©dito -->
            <div class="mb-6">
                <button id="card-option" class="w-full p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors payment-option" data-type="card">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <span class="text-2xl">üí≥</span>
                            </div>
                            <div class="text-left">
                                <h3 class="font-semibold text-gray-800">Cart√£o de Cr√©dito</h3>
                                <p class="text-sm text-gray-600">Visa, Mastercard, Elo e outros</p>
                            </div>
                        </div>
                        <div class="text-green-600 font-medium">R$ {{ pagamento.valor|floatformat:2 }}</div>
                    </div>
                </button>
            </div>

            <!-- Bot√£o de Pagamento -->
            <button id="submit-payment" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span id="submit-text">Escolha uma forma de pagamento</span>
                <div id="loading-spinner" class="hidden">
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                        Processando...
                    </div>
                </div>
            </button>
        </div>

        <!-- Status do Pagamento -->
        <div id="payment-status" class="hidden mt-6 p-4 rounded-lg">
            <div id="status-icon" class="text-center mb-2"></div>
            <div id="status-title" class="text-center font-semibold mb-1"></div>
            <div id="status-message" class="text-center text-sm text-gray-600"></div>
        </div>
    </div>
</div>

<!-- Vari√°veis Django para JavaScript -->
<div id="django-vars" 
     data-pix-available="{% if pix_available %}true{% else %}false{% endif %}"
     data-init-point="{{ init_point|default:'' }}"
     data-preference-id="{{ preference_id|default:'' }}"
     style="display: none;">
</div>

<script>
// Vari√°veis do Django
const djangoVars = document.getElementById('django-vars');
const PIX_AVAILABLE = djangoVars.dataset.pixAvailable === 'true';
const INIT_POINT = djangoVars.dataset.initPoint;
const PREFERENCE_ID = djangoVars.dataset.preferenceId;

// Elementos do DOM
const paymentOptions = document.querySelectorAll('.payment-option');
const submitButton = document.getElementById('submit-payment');
const submitText = document.getElementById('submit-text');
const loadingSpinner = document.getElementById('loading-spinner');
const paymentStatus = document.getElementById('payment-status');
const statusIcon = document.getElementById('status-icon');
const statusTitle = document.getElementById('status-title');
const statusMessage = document.getElementById('status-message');

let currentPaymentType = null;

// Configurar op√ß√µes de pagamento
paymentOptions.forEach(option => {
    option.addEventListener('click', () => {
        // Remover sele√ß√£o anterior
        paymentOptions.forEach(opt => {
            opt.classList.remove('border-blue-500', 'bg-blue-50');
            opt.classList.add('border-gray-200');
        });
        
        // Selecionar op√ß√£o atual
        option.classList.remove('border-gray-200');
        option.classList.add('border-blue-500', 'bg-blue-50');
        
        // Atualizar tipo de pagamento
        currentPaymentType = option.dataset.type;
        
        // Habilitar bot√£o de pagamento
        submitButton.disabled = false;
        submitText.textContent = 'Prosseguir para o pagamento';
        
        // Configurar checkout baseado no tipo
        if (currentPaymentType === 'pix') {
            setupPixCheckout();
        } else if (currentPaymentType === 'card') {
            setupCardCheckout();
        }
    });
});

// Configurar checkout PIX
function setupPixCheckout() {
    console.log('Configurando checkout PIX...');
    console.log('PIX dispon√≠vel:', PIX_AVAILABLE);
    console.log('Init Point:', INIT_POINT);
    
    if (PIX_AVAILABLE) {
        console.log('‚úÖ PIX dispon√≠vel - Redirecionamento para Mercado Pago');
    } else {
        console.log('‚ùå PIX n√£o dispon√≠vel');
    }
}

// Configurar checkout Cart√£o
function setupCardCheckout() {
    console.log('Configurando checkout Cart√£o...');
    console.log('Init Point:', INIT_POINT);
    console.log('‚úÖ P√°gina oficial do Mercado Pago');
}

// Configurar bot√£o de pagamento
submitButton.addEventListener('click', () => {
    if (!currentPaymentType) return;
    
    // Desabilitar bot√£o e mostrar loading
    submitButton.disabled = true;
    submitText.classList.add('hidden');
    loadingSpinner.classList.remove('hidden');
    
    try {
               if (currentPaymentType === 'pix') {
                   // PIX - USAR PIX DIRETO (SEM MERCADO PAGO)
                   console.log('üîµ PIX SELECIONADO - USANDO PIX DIRETO');
                   console.log('‚úÖ GERANDO QR CODE PIX DIRETAMENTE');
                   
                   showStatus('loading', 'Gerando PIX...', 'Aguarde, estamos gerando seu c√≥digo PIX');
                   
                   // Gerar PIX diretamente
                   const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                   console.log('üîê CSRF Token:', csrfToken ? 'Encontrado' : 'N√ÉO ENCONTRADO');
                   
                   const url = `/payments/gerar-pix/{{ pagamento.id }}/`;
                   console.log('üåê URL da API PIX:', url);
                   
                   const requestOptions = {
                       method: 'POST',
                       headers: {
                           'Content-Type': 'application/json',
                           'X-CSRFToken': csrfToken ? csrfToken.value : ''
                       }
                   };
                   
                   console.log('üì§ Enviando requisi√ß√£o PIX:', requestOptions);
                   
                   fetch(url, requestOptions)
                   .then(response => {
                       console.log('üì• Resposta recebida da API PIX:');
                       console.log('   Status:', response.status);
                       console.log('   OK:', response.ok);
                       
                       if (!response.ok) {
                           console.error('‚ùå Resposta n√£o OK:', response.status);
                       }
                       
                       return response.json();
                   })
                   .then(data => {
                       console.log('üìä Dados recebidos da API PIX:', data);
                       console.log('üîç QR Code Base64:', data.qr_code_base64 ? 'Dispon√≠vel' : 'N√ÉO DISPON√çVEL');
                       console.log('üîç Debug Info:', data.debug_info);
                       
                       if (data.success) {
                           // PIX gerado com sucesso, mostrar QR Code
                           console.log('‚úÖ PIX GERADO COM SUCESSO!');
                           console.log('üñºÔ∏è Mostrando QR Code...');
                           showPixQRCode(data);
                       } else {
                           // Erro ao gerar PIX, mostrar erro
                           console.error('‚ùå ERRO AO GERAR PIX:', data.error);
                           showStatus('error', 'Erro no PIX', data.error || 'Erro ao gerar PIX. Tente novamente ou use cart√£o de cr√©dito.');
                           
                           // Reabilitar bot√£o para tentar novamente
                           submitButton.disabled = false;
                           submitText.classList.remove('hidden');
                           loadingSpinner.classList.add('hidden');
                       }
                   })
                   .catch(error => {
                       console.error('‚ùå ERRO DE CONEX√ÉO AO GERAR PIX:', error);
                       showStatus('error', 'Erro no PIX', 'Erro de conex√£o. Tente novamente ou use cart√£o de cr√©dito.');
                       
                       // Reabilitar bot√£o para tentar novamente
                       submitButton.disabled = false;
                       submitText.classList.remove('hidden');
                       loadingSpinner.classList.add('hidden');
                   });
        } else if (currentPaymentType === 'card') {
            // Cart√£o - Detectar ambiente e usar estrat√©gia apropriada
            console.log('üîµ CART√ÉO SELECIONADO - DETECTANDO AMBIENTE');
            
            // Verificar se estamos em sandbox (TEST- no public key)
            const isSandbox = '{{ public_key|default:"" }}'.startsWith('TEST-');
            
            if (isSandbox) {
                // SANDBOX: Simular pagamento
                console.log('üß™ AMBIENTE SANDBOX - SIMULANDO PAGAMENTO');
                console.log('‚úÖ USANDO CART√ÉO - SIMULA√á√ÉO PARA TESTE');
                
                showStatus('loading', 'Processando pagamento...', 'Simulando pagamento com cart√£o de cr√©dito...');
                
                // Simular processamento do cart√£o
                setTimeout(() => {
                    console.log('‚úÖ PAGAMENTO SIMULADO COM SUCESSO!');
                    showStatus('success', 'Pagamento aprovado!', 'Pagamento com cart√£o processado com sucesso! Redirecionando...');
                    
                    // Simular redirecionamento para p√°gina principal (index.html)
                    setTimeout(() => {
                        console.log('üöÄ Redirecionando para index.html...');
                        window.location.href = '/index/';
                    }, 2000);
                    
                }, 3000);
            } else {
                // PRODU√á√ÉO: Usar Mercado Pago real
                console.log('üöÄ AMBIENTE PRODU√á√ÉO - USANDO MERCADO PAGO REAL');
                console.log('‚úÖ USANDO CART√ÉO - MERCADO PAGO REAL');
                
                showStatus('loading', 'Preparando pagamento...', 'Criando nova sess√£o de pagamento...');
                
                // Criar nova prefer√™ncia para cart√£o
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                console.log('üîê CSRF Token:', csrfToken ? 'Encontrado' : 'N√ÉO ENCONTRADO');
                
                const url = `/payments/criar-pagamento-cartao/{{ pagamento.id }}/`;
                console.log('üåê URL da API Cart√£o:', url);
                
                const requestOptions = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken ? csrfToken.value : ''
                    }
                };
                
                console.log('üì§ Enviando requisi√ß√£o para criar prefer√™ncia de cart√£o...');
                
                fetch(url, requestOptions)
                .then(response => {
                    console.log('üì• Resposta recebida da API Cart√£o:');
                    console.log('   Status:', response.status);
                    console.log('   OK:', response.ok);
                    
                    if (!response.ok) {
                        console.error('‚ùå Resposta n√£o OK:', response.status);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Dados recebidos da API Cart√£o:', data);
                    
                    if (data.success && data.init_point) {
                        // Prefer√™ncia criada com sucesso, redirecionar
                        console.log('‚úÖ PREFER√äNCIA DE CART√ÉO CRIADA COM SUCESSO!');
                        console.log('   Init Point:', data.init_point);
                        
                        showStatus('loading', 'Redirecionando...', 'Abrindo p√°gina segura do Mercado Pago...');
                        
                        // Validar URL antes de redirecionar
                        if (data.init_point && data.init_point.includes('mercadopago.com.br') && data.init_point.includes('pref_id=')) {
                            console.log('‚úÖ URL v√°lida confirmada:', data.init_point);
                            console.log('üîÑ Redirecionando em 1 segundo...');
                            
                            setTimeout(() => {
                                console.log('üöÄ Executando redirecionamento para:', data.init_point);
                                window.location.href = data.init_point;
                            }, 1000);
                        } else {
                            console.error('‚ùå URL inv√°lida:', data.init_point);
                            showStatus('error', 'Erro', 'URL de pagamento inv√°lida. Tente novamente.');
                            submitButton.disabled = false;
                            submitText.classList.remove('hidden');
                            loadingSpinner.classList.add('hidden');
                        }
                    } else {
                        // Erro ao criar prefer√™ncia
                        console.error('‚ùå ERRO AO CRIAR PREFER√äNCIA DE CART√ÉO:', data.error);
                        showStatus('error', 'Erro no cart√£o', data.error || 'Erro ao criar sess√£o de pagamento. Tente novamente.');
                        
                        // Reabilitar bot√£o para tentar novamente
                        submitButton.disabled = false;
                        submitText.classList.remove('hidden');
                        loadingSpinner.classList.add('hidden');
                    }
                })
                .catch(error => {
                    console.error('‚ùå ERRO DE CONEX√ÉO AO CRIAR PREFER√äNCIA DE CART√ÉO:', error);
                    showStatus('error', 'Erro no cart√£o', 'Erro de conex√£o. Tente novamente.');
                    
                    // Reabilitar bot√£o para tentar novamente
                    submitButton.disabled = false;
                    submitText.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                });
            }
        }
    } catch (error) {
        console.error('Erro no pagamento:', error);
        showStatus('error', 'Erro', 'Ocorreu um erro inesperado. Tente novamente.');
        
        // Reabilitar bot√£o
        submitButton.disabled = false;
        submitText.classList.remove('hidden');
        loadingSpinner.classList.add('hidden');
    }
});

// Fun√ß√£o para mostrar status
function showStatus(type, title, message) {
    statusIcon.innerHTML = '';
    statusTitle.textContent = title;
    statusMessage.textContent = message;
    
    if (type === 'loading') {
        statusIcon.innerHTML = '<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>';
        paymentStatus.className = 'mt-6 p-4 rounded-lg bg-blue-50 border border-blue-200';
    } else if (type === 'success') {
        statusIcon.innerHTML = '<div class="text-green-600 text-4xl">‚úÖ</div>';
        paymentStatus.className = 'mt-6 p-4 rounded-lg bg-green-50 border border-green-200';
    } else if (type === 'error') {
        statusIcon.innerHTML = '<div class="text-red-600 text-4xl">‚ùå</div>';
        paymentStatus.className = 'mt-6 p-4 rounded-lg bg-red-50 border border-red-200';
    }
    
    paymentStatus.classList.remove('hidden');
}

// Fun√ß√£o para esconder status
function hideStatus() {
    paymentStatus.classList.add('hidden');
}

// Fun√ß√£o para mostrar QR Code PIX
function showPixQRCode(data) {
    console.log('üéØ Mostrando QR Code PIX:', data);
    console.log('üñºÔ∏è QR Code Base64:', data.qr_code_base64 ? 'Dispon√≠vel' : 'N√ÉO DISPON√çVEL');
    console.log('üìè Tamanho do QR Code:', data.qr_code_base64 ? data.qr_code_base64.length : 'N/A');
    
    // Criar modal para QR Code
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="text-center">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Pagamento PIX</h3>
                <p class="text-gray-600 mb-4">Escaneie o QR Code com seu app banc√°rio</p>
                
                <div class="bg-gray-100 p-4 rounded-lg mb-4">
                    ${data.qr_code_base64 ? 
                        `<img src="data:image/png;base64,${data.qr_code_base64}" alt="QR Code PIX" class="mx-auto max-w-full h-auto">` :
                        `<div class="text-gray-500">QR Code n√£o dispon√≠vel</div>`
                    }
                </div>
                
                <div class="text-sm text-gray-600 mb-4">
                    <p><strong>Valor:</strong> R$ {{ pagamento.valor|floatformat:2 }}</p>
                    <p><strong>Descri√ß√£o:</strong> {{ pagamento.descricao }}</p>
                </div>
                
                <div class="text-center">
                    <button onclick="this.closest('.fixed').remove()" class="bg-blue-600 text-white py-3 px-8 rounded-lg hover:bg-blue-700 font-semibold">
                        Fechar
                    </button>
                </div>
                
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-600">
                        üí° <strong>Ap√≥s fazer o PIX, voc√™ ser√° redirecionado automaticamente para o dashboard</strong>
                    </p>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Esconder status e reabilitar bot√£o
    hideStatus();
    submitButton.disabled = false;
    submitText.classList.remove('hidden');
    loadingSpinner.classList.add('hidden');
    
    // Verificar status automaticamente a cada 2 segundos
    let checkCount = 0;
    const maxChecks = 150; // 5 minutos m√°ximo (150 * 2 segundos)
    
    const checkInterval = setInterval(async () => {
        try {
            checkCount++;
            console.log(`Verifica√ß√£o autom√°tica ${checkCount}/${maxChecks}`);
            
            const response = await fetch(`/payments/verificar-status/{{ pagamento.id }}/`);
            const statusData = await response.json();
            
            console.log('Status verificado:', statusData);
            
            if (statusData.status === 'approved' && statusData.assinatura_ativa) {
                clearInterval(checkInterval);
                modal.remove();
                showStatus('success', 'Pagamento Confirmado!', 'Sua assinatura foi ativada. Redirecionando...');
                setTimeout(() => {
                    window.location.href = '/payments/bem-vindo/{{ pagamento.id }}/';
                }, 2000);
            } else if (statusData.status === 'approved' && !statusData.assinatura_ativa) {
                console.log('Pagamento aprovado mas assinatura n√£o ativa ainda');
            } else if (statusData.status === 'rejected' || statusData.status === 'cancelled') {
                clearInterval(checkInterval);
                modal.remove();
                showStatus('error', 'Pagamento n√£o aprovado', 'O pagamento foi rejeitado ou cancelado');
            }
            
            // Parar verifica√ß√£o ap√≥s tempo limite
            if (checkCount >= maxChecks) {
                clearInterval(checkInterval);
                console.log('Verifica√ß√£o autom√°tica encerrada por tempo limite');
            }
        } catch (error) {
            console.error('Erro ao verificar status:', error);
        }
    }, 2000);
}

// Fun√ß√£o removida - verifica√ß√£o agora √© autom√°tica

console.log('Checkout inicializado');
console.log('Public Key:', '{{ public_key }}');
console.log('Preference ID:', '{{ preference_id }}');
console.log('Init Point:', '{{ init_point }}');
console.log('PIX Available:', '{{ pix_available }}');
</script>
{% endblock %}
