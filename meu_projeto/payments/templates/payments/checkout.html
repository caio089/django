{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Pagamento - Academia de Judô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- SDK do Mercado Pago -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
</head>
<body class="bg-gray-50 font-sans">
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Finalizar Pagamento</h1>
        <p class="text-gray-600">Complete sua assinatura premium</p>
    </div>

    <!-- Informações do Plano -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-blue-800">{{ pagamento.descricao }}</h2>
                <p class="text-blue-600">Valor: <span class="font-bold text-lg">R$ {{ pagamento.valor|default:"0"|floatformat:2 }}</span></p>
            </div>
            <div class="text-right">
                <p class="text-sm text-blue-600">Referência:</p>
                <p class="text-xs text-blue-500">{{ pagamento.external_reference }}</p>
            </div>
        </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
        <!-- Formulário de Pagamento -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Escolha a forma de pagamento</h3>
            
            <!-- Container do Mercado Pago -->
            <div id="mercadopago-checkout" class="space-y-4">
                <!-- PIX -->
                <div class="payment-option" data-type="pix">
                    <button type="button" class="w-full p-4 border border-gray-300 rounded-lg hover:border-blue-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <div class="font-medium">PIX</div>
                                <div class="text-sm text-gray-500">Aprovação instantânea</div>
                            </div>
                        </div>
                    </button>
                </div>

                <!-- Cartão de Crédito -->
                <div class="payment-option" data-type="card">
                    <button type="button" class="w-full p-4 border border-gray-300 rounded-lg hover:border-blue-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <div class="font-medium">Cartão de Crédito</div>
                                <div class="text-sm text-gray-500">Visa, Mastercard, Elo</div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Container para elementos do Mercado Pago -->
            <div id="mercadopago-elements" class="mt-6">
                <!-- Os elementos do Mercado Pago serão inseridos aqui -->
            </div>

            <!-- Botão de pagamento -->
            <div id="submit-container" class="mt-6 hidden">
                <button id="submit-payment" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="submit-text">Pagar R$ {{ pagamento.valor|default:"0"|floatformat:2 }}</span>
                    <div id="loading-spinner" class="hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Processando...
                    </div>
                </button>
            </div>
        </div>

        <!-- Resumo e Informações -->
        <div class="space-y-6">
            <!-- Resumo do Pedido -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Resumo do Pedido</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span>Plano:</span>
                        <span class="font-medium">{{ pagamento.descricao }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Valor:</span>
                        <span class="font-medium">R$ {{ pagamento.valor|default:"0"|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between border-t pt-3">
                        <span class="font-bold">Total:</span>
                        <span class="font-bold text-lg">R$ {{ pagamento.valor|default:"0"|floatformat:2 }}</span>
                    </div>
                </div>
            </div>

            <!-- Benefícios Premium -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                <h3 class="text-xl font-bold text-green-800 mb-4">O que você ganha:</h3>
                <ul class="space-y-2">
                    <li class="flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-green-700">Acesso completo ao quiz ilimitado</span>
                    </li>
                    <li class="flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-green-700">Progresso detalhado e estatísticas</span>
                    </li>
                    <li class="flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-green-700">Relatórios avançados de desempenho</span>
                    </li>
                    <li class="flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-green-700">Suporte prioritário</span>
                    </li>
                </ul>
            </div>

            <!-- Segurança -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <div class="flex items-center text-gray-600">
                    <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="text-sm">Pagamento 100% seguro processado pelo Mercado Pago</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Status do Pagamento -->
    <div id="payment-status" class="hidden mt-6">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center">
                <div id="status-icon" class="w-6 h-6 mr-3"></div>
                <div>
                    <h4 id="status-title" class="font-medium text-blue-800"></h4>
                    <p id="status-message" class="text-sm text-blue-600"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Configuração do Mercado Pago
const PUBLIC_KEY = '{{ public_key }}';
const PREFERENCE_ID = '{{ preference_id }}';
const PAYMENT_ID = {{ pagamento.id|default:0 }};

// Inicializar SDK do Mercado Pago
const mp = new MercadoPago(PUBLIC_KEY);

let currentPaymentType = null;
let checkout = null;

// Elementos do DOM
const elementsContainer = document.getElementById('mercadopago-elements');
const submitContainer = document.getElementById('submit-container');
const submitButton = document.getElementById('submit-payment');
const submitText = document.getElementById('submit-text');
const loadingSpinner = document.getElementById('loading-spinner');
const paymentStatus = document.getElementById('payment-status');
const statusIcon = document.getElementById('status-icon');
const statusTitle = document.getElementById('status-title');
const statusMessage = document.getElementById('status-message');

// Função para mostrar status
function showStatus(type, title, message) {
    statusIcon.innerHTML = '';
    
    if (type === 'success') {
        statusIcon.innerHTML = '<svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
        paymentStatus.className = 'mt-6 bg-green-50 border border-green-200 rounded-lg p-4';
    } else if (type === 'error') {
        statusIcon.innerHTML = '<svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
        paymentStatus.className = 'mt-6 bg-red-50 border border-red-200 rounded-lg p-4';
    } else {
        statusIcon.innerHTML = '<svg class="w-6 h-6 text-blue-500 animate-spin" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>';
        paymentStatus.className = 'mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4';
    }
    
    statusTitle.textContent = title;
    statusMessage.textContent = message;
    paymentStatus.classList.remove('hidden');
}

// Função para esconder status
function hideStatus() {
    paymentStatus.classList.add('hidden');
}

// Função para configurar checkout PIX
async function setupPixCheckout() {
    try {
        hideStatus();
        showStatus('loading', 'Configurando PIX...', 'Preparando pagamento instantâneo');
        
        // Criar checkout para PIX
        checkout = mp.checkout({
            preference: {
                id: PREFERENCE_ID
            },
            render: {
                container: elementsContainer,
                label: 'Pagar com PIX'
            }
        });
        
        currentPaymentType = 'pix';
        submitContainer.classList.remove('hidden');
        submitText.textContent = 'Gerar PIX';
        
    } catch (error) {
        console.error('Erro ao configurar PIX:', error);
        showStatus('error', 'Erro no PIX', 'Não foi possível configurar o pagamento PIX');
    }
}

// Função para configurar checkout com cartão
async function setupCardCheckout() {
    try {
        hideStatus();
        showStatus('loading', 'Configurando cartão...', 'Preparando pagamento com cartão de crédito');
        
        // Criar elementos do cartão
        const cardForm = mp.cardForm({
            amount: "{% if pagamento.valor %}{{ pagamento.valor }}{% else %}0{% endif %}",
            iframe: true,
            form: {
                id: "form-checkout",
                cardNumber: {
                    id: "form-checkout__cardNumber",
                    placeholder: "Número do cartão",
                },
                expirationDate: {
                    id: "form-checkout__expirationDate",
                    placeholder: "MM/AA",
                },
                securityCode: {
                    id: "form-checkout__securityCode",
                    placeholder: "Código de segurança",
                },
                cardholderName: {
                    id: "form-checkout__cardholderName",
                    placeholder: "Nome no cartão",
                },
                issuer: {
                    id: "form-checkout__issuer",
                    placeholder: "Banco emissor",
                },
                installments: {
                    id: "form-checkout__installments",
                    placeholder: "Parcelas",
                },
                identificationType: {
                    id: "form-checkout__identificationType",
                    placeholder: "Tipo de documento",
                },
                identificationNumber: {
                    id: "form-checkout__identificationNumber",
                    placeholder: "Número do documento",
                },
                cardholderEmail: {
                    id: "form-checkout__cardholderEmail",
                    placeholder: "E-mail",
                },
            },
            callbacks: {
                onFormMounted: error => {
                    if (error) {
                        console.error('Erro ao montar formulário:', error);
                        showStatus('error', 'Erro no formulário', 'Não foi possível carregar o formulário do cartão');
                    } else {
                        hideStatus();
                        currentPaymentType = 'card';
                        submitContainer.classList.remove('hidden');
                        submitText.textContent = 'Pagar com Cartão';
                    }
                },
            },
        });
        
    } catch (error) {
        console.error('Erro ao configurar cartão:', error);
        showStatus('error', 'Erro no cartão', 'Não foi possível configurar o pagamento com cartão');
    }
}

// Event listeners para opções de pagamento
document.querySelectorAll('.payment-option').forEach(option => {
    option.addEventListener('click', async () => {
        const type = option.dataset.type;
        
        // Limpar elementos anteriores
        elementsContainer.innerHTML = '';
        submitContainer.classList.add('hidden');
        
        if (type === 'pix') {
            await setupPixCheckout();
        } else if (type === 'card') {
            await setupCardCheckout();
        }
    });
});

// Event listener para botão de pagamento
submitButton.addEventListener('click', async () => {
    if (!currentPaymentType) {
        showStatus('error', 'Selecione uma opção', 'Escolha PIX ou cartão para continuar');
        return;
    }
    
    submitButton.disabled = true;
    submitText.classList.add('hidden');
    loadingSpinner.classList.remove('hidden');
    
    try {
        if (currentPaymentType === 'pix') {
            // Para PIX, redirecionar para o checkout
            showStatus('loading', 'Gerando PIX...', 'Aguarde, estamos gerando seu código PIX');
            
            // Simular redirecionamento (o checkout do MP já faz isso)
            setTimeout(() => {
                window.location.href = `{% url 'payments:sucesso' %}?payment_id=${PREFERENCE_ID}`;
            }, 2000);
            
        } else if (currentPaymentType === 'card') {
            // Para cartão, processar pagamento
            showStatus('loading', 'Processando pagamento...', 'Validando dados do cartão');
            
            // Aqui você implementaria a lógica de pagamento com cartão
            // Por enquanto, vamos simular
            setTimeout(() => {
                showStatus('success', 'Pagamento aprovado!', 'Sua assinatura foi ativada com sucesso');
                setTimeout(() => {
                    window.location.href = '{% url "payments:sucesso" %}';
                }, 2000);
            }, 3000);
        }
        
    } catch (error) {
        console.error('Erro no pagamento:', error);
        showStatus('error', 'Erro no pagamento', 'Ocorreu um erro ao processar o pagamento');
        submitButton.disabled = false;
        submitText.classList.remove('hidden');
        loadingSpinner.classList.add('hidden');
    }
});

// Função para verificar status do pagamento
async function checkPaymentStatus() {
    try {
        const response = await fetch(`/payments/verificar-status/${PAYMENT_ID}/`);
        const data = await response.json();
        
        if (data.status === 'approved') {
            showStatus('success', 'Pagamento aprovado!', 'Sua assinatura foi ativada');
            setTimeout(() => {
                window.location.href = '{% url "payments:sucesso" %}';
            }, 2000);
        } else if (data.status === 'rejected') {
            showStatus('error', 'Pagamento rejeitado', 'Verifique os dados e tente novamente');
        } else if (data.status === 'pending') {
            showStatus('loading', 'Pagamento pendente', 'Aguardando confirmação');
        }
    } catch (error) {
        console.error('Erro ao verificar status:', error);
    }
}

// Verificar status a cada 5 segundos (para pagamentos PIX)
setInterval(checkPaymentStatus, 5000);

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
    console.log('Checkout inicializado');
    console.log('Public Key:', PUBLIC_KEY);
    console.log('Preference ID:', PREFERENCE_ID);
});
</script>

<!-- Header com navegação -->
<header class="bg-white shadow-sm border-b border-gray-200 mb-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <div class="flex items-center">
                <a href="{% url 'index' %}" class="flex items-center space-x-2">
                    <img src="{% static 'judo.png' %}" alt="Judo" class="h-8 w-8">
                    <span class="text-xl font-bold text-gray-800">Academia de Judô</span>
                </a>
            </div>
            <div class="flex items-center space-x-4">
                {% if user.is_authenticated %}
                    <span class="text-sm text-gray-600">Olá, {{ user.first_name|default:user.username }}</span>
                    <form method="post" action="{% url 'logout' %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            Logout
                        </button>
                    </form>
                {% else %}
                    <a href="{% url 'login' %}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Login
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</header>

<!-- Messages -->
{% if messages %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} bg-{% if message.tags == 'error' %}red{% elif message.tags == 'warning' %}yellow{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-100 border border-{% if message.tags == 'error' %}red{% elif message.tags == 'warning' %}yellow{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-400 text-{% if message.tags == 'error' %}red{% elif message.tags == 'warning' %}yellow{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-700 px-4 py-3 rounded mb-4">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

</body>
</html>
