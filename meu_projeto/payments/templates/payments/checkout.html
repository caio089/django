{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Pagamento - Academia de Judô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- SDK do Mercado Pago -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    
</head>
<body class="bg-gray-50 font-sans">
{% csrf_token %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Finalizar Pagamento</h1>
        <p class="text-gray-600">Complete sua assinatura premium</p>
    </div>

    <!-- Informações do Plano -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-blue-800">{{ pagamento.descricao }}</h2>
                <p class="text-blue-600">Valor: <span class="font-bold text-lg">R$ {{ pagamento.valor|default:"0"|floatformat:2 }}</span></p>
            </div>
            <div class="text-right">
                <p class="text-sm text-blue-600">Referência:</p>
                <p class="text-xs text-blue-500">{{ pagamento.external_reference }}</p>
            </div>
        </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
        <!-- Formulário de Pagamento -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Escolha a forma de pagamento</h3>
            
            <!-- Container do Mercado Pago -->
            <div id="mercadopago-checkout" class="space-y-4">
                <!-- PIX -->
                <div class="payment-option" data-type="pix">
                    <button type="button" class="w-full p-4 border border-gray-300 rounded-lg hover:border-blue-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <div class="font-medium">PIX</div>
                                <div class="text-sm text-gray-500">Aprovação instantânea</div>
                                {% if not pix_available %}
                                <div class="text-xs text-orange-500 mt-1">⚠️ PIX via API direta</div>
                                {% else %}
                                <div class="text-xs text-green-500 mt-1">✅ PIX disponível no Mercado Pago</div>
                                {% endif %}
                            </div>
                        </div>
                    </button>
                </div>

                <!-- Cartão de Crédito -->
                <div class="payment-option" data-type="card">
                    <button type="button" class="w-full p-4 border border-gray-300 rounded-lg hover:border-blue-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <div class="font-medium">Cartão de Crédito</div>
                                <div class="text-sm text-gray-500">Visa, Mastercard, Elo</div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Container para elementos do Mercado Pago -->
            <div id="mercadopago-elements" class="mt-6">
                <!-- Os elementos do Mercado Pago serão inseridos aqui -->
            </div>

            <!-- Botão de pagamento -->
            <div id="submit-container" class="mt-6 hidden">
                <button id="submit-payment" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="submit-text">Pagar R$ {{ pagamento.valor|default:"0"|floatformat:2 }}</span>
                    <div id="loading-spinner" class="hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Processando...
                    </div>
                </button>
            </div>
        </div>

        <!-- Resumo e Informações -->
        <div class="space-y-6">
            <!-- Resumo do Pedido -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Resumo do Pedido</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span>Plano:</span>
                        <span class="font-medium">{{ pagamento.descricao }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Valor:</span>
                        <span class="font-medium">R$ {{ pagamento.valor|default:"0"|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between border-t pt-3">
                        <span class="font-bold">Total:</span>
                        <span class="font-bold text-lg">R$ {{ pagamento.valor|default:"0"|floatformat:2 }}</span>
                    </div>
                </div>
            </div>

            <!-- Benefícios Premium -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                <h3 class="text-xl font-bold text-green-800 mb-4">O que você ganha:</h3>
                <ul class="space-y-2">
                    <li class="flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-green-700">Acesso completo ao quiz ilimitado</span>
                    </li>
                    <li class="flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-green-700">Progresso detalhado e estatísticas</span>
                    </li>
                    <li class="flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-green-700">Relatórios avançados de desempenho</span>
                    </li>
                    <li class="flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-green-700">Suporte prioritário</span>
                    </li>
                </ul>
            </div>

            <!-- Segurança -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <div class="flex items-center text-gray-600">
                    <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="text-sm">Pagamento 100% seguro processado pelo Mercado Pago</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Status do Pagamento -->
    <div id="payment-status" class="hidden mt-6">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center">
                <div id="status-icon" class="w-6 h-6 mr-3"></div>
                <div>
                    <h4 id="status-title" class="font-medium text-blue-800"></h4>
                    <p id="status-message" class="text-sm text-blue-600"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Variáveis do Django como atributos HTML -->
<div id="django-vars" 
     data-pix-available="{% if pix_available %}true{% else %}false{% endif %}"
     data-init-point="{{ init_point|default:'' }}"
     data-preference-id="{{ preference_id|default:'' }}"
     style="display: none;">
</div>

<script>
// Variáveis do Django para JavaScript
const PUBLIC_KEY = '{{ public_key }}';
const PREFERENCE_ID = '{{ preference_id }}';
const PAYMENT_ID = '{{ pagamento.id }}';
const PAYMENT_VALUE = '{{ pagamento.valor }}';
const PAYMENT_DESCRIPTION = '{{ pagamento.descricao }}';

// Variáveis do Django para PIX
const djangoVars = document.getElementById('django-vars');
const PIX_AVAILABLE = djangoVars.dataset.pixAvailable === 'true';
const INIT_POINT = djangoVars.dataset.initPoint;

// Inicializar SDK do Mercado Pago
let mp = null;
if (PUBLIC_KEY && PUBLIC_KEY !== '') {
    try {
        mp = new MercadoPago(PUBLIC_KEY, {
            locale: 'pt-BR',
            advancedFraudPrevention: false, // Desabilitar para ambiente de desenvolvimento
            enableRecaptcha: false // Desabilitar reCAPTCHA para evitar erros 401
        });
        console.log('✅ SDK do Mercado Pago inicializado com sucesso');
    } catch (error) {
        console.error('❌ Erro ao inicializar SDK do Mercado Pago:', error);
        console.log('💡 Dica: Verifique se a chave pública está correta');
    }
} else {
    console.warn('⚠️ PUBLIC_KEY não encontrada ou vazia');
}

// Suprimir erros de reCAPTCHA em desenvolvimento
window.addEventListener('error', function(e) {
    if (e.message && e.message.includes('recaptcha')) {
        console.warn('⚠️ Erro de reCAPTCHA suprimido (normal em desenvolvimento)');
        e.preventDefault();
        return false;
    }
});

let currentPaymentType = null;
let checkout = null;

// Elementos do DOM
const elementsContainer = document.getElementById('mercadopago-elements');
const submitContainer = document.getElementById('submit-container');
const submitButton = document.getElementById('submit-payment');
const submitText = document.getElementById('submit-text');
const loadingSpinner = document.getElementById('loading-spinner');
const paymentStatus = document.getElementById('payment-status');
const statusIcon = document.getElementById('status-icon');
const statusTitle = document.getElementById('status-title');
const statusMessage = document.getElementById('status-message');

// Função para mostrar status
function showStatus(type, title, message) {
    statusIcon.innerHTML = '';
    
    if (type === 'success') {
        statusIcon.innerHTML = '<svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
        paymentStatus.className = 'mt-6 bg-green-50 border border-green-200 rounded-lg p-4';
    } else if (type === 'error') {
        statusIcon.innerHTML = '<svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
        paymentStatus.className = 'mt-6 bg-red-50 border border-red-200 rounded-lg p-4';
    } else {
        statusIcon.innerHTML = '<svg class="w-6 h-6 text-blue-500 animate-spin" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>';
        paymentStatus.className = 'mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4';
    }
    
    statusTitle.textContent = title;
    statusMessage.textContent = message;
    paymentStatus.classList.remove('hidden');
}

// Função para esconder status
function hideStatus() {
    paymentStatus.classList.add('hidden');
}

// Função para testar QR Code PIX
function testarQrCode(qrCode) {
    console.log('Testando QR Code PIX:', qrCode);
    
    // Validar formato do QR Code PIX
    if (!qrCode || qrCode.length < 100) {
        alert('QR Code inválido: muito curto');
        return;
    }
    
    // Verificar se começa com 000201 (padrão PIX)
    if (!qrCode.startsWith('000201')) {
        alert('QR Code inválido: não começa com padrão PIX (000201)');
        return;
    }
    
    // Verificar se contém dados essenciais do PIX
    const pixData = {
        hasMerchantName: qrCode.includes('59'),
        hasTransactionAmount: qrCode.includes('54'),
        hasMerchantCity: qrCode.includes('60'),
        hasMerchantAccount: qrCode.includes('26'),
        hasCRC: qrCode.includes('6304'),
        hasPixKey: qrCode.includes('br.gov.bcb.pix')
    };
    
    console.log('Análise do QR Code PIX:', pixData);
    
    // Extrair informações específicas do QR Code
    const amountMatch = qrCode.match(/54(\d{2})(\d+)/);
    const merchantNameMatch = qrCode.match(/59(\d{2})([^0-9]+)/);
    const cityMatch = qrCode.match(/60(\d{2})([^0-9]+)/);
    
    const extractedData = {
        amount: amountMatch ? (parseInt(amountMatch[2]) / 100).toFixed(2) : 'N/A',
        merchantName: merchantNameMatch ? merchantNameMatch[2] : 'N/A',
        city: cityMatch ? cityMatch[2] : 'N/A'
    };
    
    console.log('Dados extraídos do QR Code:', extractedData);
    
    // Análise detalhada do QR Code
    const qrAnalysis = {
        startsWith000201: qrCode.startsWith('000201'),
        hasPixKey: qrCode.includes('br.gov.bcb.pix'),
        hasAmount: qrCode.includes('54'),
        hasMerchantName: qrCode.includes('59'),
        hasCity: qrCode.includes('60'),
        hasCRC: qrCode.includes('6304'),
        length: qrCode.length,
        endsWithCRC: qrCode.endsWith('E1CD') || qrCode.endsWith('D5F2')
    };
    
    console.log('Análise detalhada do QR Code:', qrAnalysis);
    
    // Verificar apenas campos essenciais
    const essentialFields = ['hasMerchantName', 'hasTransactionAmount', 'hasMerchantCity', 'hasMerchantAccount', 'hasCRC', 'hasPixKey'];
    const missingEssentialFields = essentialFields.filter(field => !pixData[field]);
    
    if (missingEssentialFields.length > 0) {
        console.warn('⚠️ Campos essenciais ausentes:', missingEssentialFields);
        // Não mostrar alerta, apenas log de warning
    }
    
    // Verificar se pelo menos os campos mais importantes estão presentes
    const criticalFields = ['hasTransactionAmount', 'hasMerchantAccount', 'hasCRC'];
    const missingCriticalFields = criticalFields.filter(field => !pixData[field]);
    
    if (missingCriticalFields.length > 0) {
        alert(`QR Code inválido: campos críticos ausentes: ${missingCriticalFields.join(', ')}`);
        return;
    }
    
    // Mostrar informações detalhadas
    const info = `
QR Code PIX VÁLIDO! ✅

Informações extraídas:
• Valor: R$ ${extractedData.amount}
• Merchant: ${extractedData.merchantName}
• Cidade: ${extractedData.city}
• Tamanho: ${qrCode.length} caracteres

Análise técnica:
• Formato PIX: ${qrAnalysis.startsWith000201 ? '✅' : '❌'}
• Chave PIX: ${qrAnalysis.hasPixKey ? '✅' : '❌'}
• Valor: ${qrAnalysis.hasAmount ? '✅' : '❌'}
• Merchant: ${qrAnalysis.hasMerchantName ? '✅' : '❌'}
• Cidade: ${qrAnalysis.hasCity ? '✅' : '❌'}
• CRC: ${qrAnalysis.hasCRC ? '✅' : '❌'}
• Info Merchant: ${qrAnalysis.hasMerchantInfo ? '✅' : '❌'}
• Termina com CRC: ${qrAnalysis.endsWithCRC ? '✅' : '❌'}

Pode ser usado para pagamento!
    `;
    
    alert(info);
}

// Função para testar QR Code com diferentes bancos
function testarComBancos(qrCode) {
    console.log('Testando QR Code com diferentes bancos:', qrCode);
    
    const bancos = [
        { nome: 'Nubank', app: 'nuapp://pix' },
        { nome: 'Itaú', app: 'itau://pix' },
        { nome: 'Bradesco', app: 'bradesco://pix' },
        { nome: 'Santander', app: 'santander://pix' },
        { nome: 'Caixa', app: 'caixa://pix' },
        { nome: 'Banco do Brasil', app: 'bb://pix' }
    ];
    
    const info = `
QR Code PIX - Teste com Bancos 🏦

Código: ${qrCode.substring(0, 50)}...

Bancos para testar:
${bancos.map(banco => `• ${banco.nome}: ${banco.app}`).join('\n')}

Instruções:
1. Copie o código PIX completo
2. Abra o app do seu banco
3. Vá em PIX > Pagar com PIX
4. Cole o código ou escaneie o QR Code
5. Verifique se o banco reconhece o código

Se algum banco não reconhecer, pode ser:
• Problema no formato do QR Code
• Banco não suporta o formato
• Dados do merchant inválidos
• Status do pagamento incorreto
    `;
    
    alert(info);
}

// Função para mostrar QR Code do PIX
function showPixQRCode(data) {
    console.log('🖼️ MOSTRANDO MODAL PIX');
    console.log('   Dados recebidos:', data);
    console.log('   Success:', data.success);
    console.log('   QR Code:', data.qr_code ? data.qr_code.substring(0, 50) + '...' : 'None');
    console.log('   QR Code Base64:', data.qr_code_base64 ? data.qr_code_base64.substring(0, 50) + '...' : 'None');
    console.log('   Payment ID:', data.payment_id);
    console.log('   Status:', data.status);
    
    hideStatus();
    
    // Remover modal anterior se existir
    const existingModal = document.querySelector('.pix-modal');
    if (existingModal) {
        console.log('🗑️ Removendo modal anterior existente');
        existingModal.remove();
    } else {
        console.log('✅ Nenhum modal anterior encontrado');
    }
    
    // Criar modal com QR Code
    const modal = document.createElement('div');
    modal.className = 'pix-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">PIX - Pagamento Instantâneo</h3>
                <p class="text-gray-600 mb-6">Escaneie o QR Code com seu app bancário</p>
                
                <div class="bg-gray-100 p-4 rounded-lg mb-6">
                    ${data.qr_code_base64 ? 
                        `<img src="${data.qr_code_base64}" alt="QR Code PIX" class="mx-auto max-w-full h-auto">` :
                        `<div class="text-gray-500">QR Code não disponível</div>`
                    }
                </div>
                
                ${data.qr_code ? `
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <p class="text-xs text-yellow-800 font-medium mb-2">Código PIX (copie e cole no seu banco):</p>
                    <div class="bg-white p-2 rounded border text-xs font-mono break-all">
                        ${data.qr_code}
                    </div>
                    <div class="flex space-x-2 mt-2">
                        <button onclick="navigator.clipboard.writeText('${data.qr_code}')" class="text-xs bg-yellow-600 text-white px-2 py-1 rounded">
                            Copiar Código
                        </button>
                        <button onclick="testarQrCode('${data.qr_code}')" class="text-xs bg-green-600 text-white px-2 py-1 rounded">
                            Testar QR
                        </button>
                        <button onclick="testarComBancos('${data.qr_code}')" class="text-xs bg-blue-600 text-white px-2 py-1 rounded">
                            Testar Bancos
                        </button>
                    </div>
                    <div class="mt-2 text-xs text-gray-600">
                        <p>Status: ${data.status}</p>
                        <p>ID: ${data.payment_id}</p>
                        <p>Tamanho do código: ${data.qr_code.length} caracteres</p>
                    </div>
                </div>
                ` : ''}
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-blue-800 font-medium">Valor: R$ {{ pagamento.valor|floatformat:2 }}</p>
                    <p class="text-xs text-blue-600 mt-1">Pagamento será processado automaticamente</p>
                </div>
                
                <div class="flex space-x-4">
                    <button id="close-pix-modal" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Fechar
                    </button>
                    <button id="paid-pix-modal" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        Já Paguei
                    </button>
                </div>
            </div>
        </div>
    `;
    
    console.log('📝 Adicionando modal ao DOM...');
    document.body.appendChild(modal);
    console.log('✅ Modal adicionado ao DOM');
    
    // Testar QR Code automaticamente
    if (data.qr_code) {
        console.log('🧪 Testando QR Code automaticamente...');
        testarQrCode(data.qr_code);
    } else {
        console.log('⚠️ Nenhum QR Code para testar');
    }
    
    // Adicionar event listeners
    console.log('🔗 Adicionando event listeners do modal...');
    
    const closeButton = document.getElementById('close-pix-modal');
    const paidButton = document.getElementById('paid-pix-modal');
    
    console.log('   Close button:', closeButton);
    console.log('   Paid button:', paidButton);
    
    if (closeButton) {
        closeButton.addEventListener('click', () => {
            console.log('❌ Botão fechar clicado');
            modal.remove();
        });
        console.log('✅ Event listener do botão fechar adicionado');
    } else {
        console.error('❌ Botão fechar não encontrado');
    }
    
    if (paidButton) {
        paidButton.addEventListener('click', () => {
            console.log('✅ Botão "Já Paguei" clicado');
            window.location.href = '{% url "payments:sucesso" %}';
        });
        console.log('✅ Event listener do botão "Já Paguei" adicionado');
    } else {
        console.error('❌ Botão "Já Paguei" não encontrado');
    }
    
    // Verificar status do pagamento a cada 5 segundos
    console.log('⏰ Iniciando verificação de status a cada 5 segundos...');
    const checkStatus = setInterval(async () => {
        try {
            console.log('🔍 Verificando status do pagamento...');
            const response = await fetch(`/payments/verificar-status/{{ pagamento.id }}/`);
            const statusData = await response.json();
            
            console.log('📊 Status recebido:', statusData);
            
            if (statusData.status === 'approved') {
                console.log('✅ Pagamento aprovado!');
                clearInterval(checkStatus);
                modal.remove();
                showStatus('success', 'Pagamento Aprovado!', 'Seu pagamento foi processado com sucesso');
                setTimeout(() => {
                    window.location.href = '{% url "payments:sucesso" %}';
                }, 2000);
            } else {
                console.log('⏳ Pagamento ainda pendente:', statusData.status);
            }
        } catch (error) {
            console.error('❌ Erro ao verificar status:', error);
        }
    }, 5000);
    
    console.log('🎉 MODAL PIX CRIADO E CONFIGURADO COM SUCESSO!');
}

// Função para configurar checkout PIX
async function setupPixCheckout() {
    console.log('🔧 CONFIGURANDO PIX CHECKOUT');
    console.log('   Elements Container:', elementsContainer);
    console.log('   Submit Container:', submitContainer);
    console.log('   Submit Button:', submitButton);
    
    try {
        hideStatus();
        showStatus('loading', 'Configurando PIX...', 'Preparando pagamento instantâneo');
        
        console.log('📝 Criando interface PIX...');
        
        // Para PIX, mostrar opção de pagamento
        elementsContainer.innerHTML = `
            <div class="text-center">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                    <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-blue-800 mb-2">PIX Instantâneo</h3>
                    <p class="text-blue-600 mb-4">Clique no botão abaixo para gerar o QR Code do PIX</p>
                    <p class="text-sm text-gray-500">QR Code será exibido automaticamente</p>
                    <p class="text-xs text-green-600 mt-2">✅ Modal PIX com QR Code direto</p>
                </div>
            </div>
        `;
        
        console.log('✅ Interface PIX criada');
        console.log('🔧 Configurando variáveis...');
        
        currentPaymentType = 'pix';
        console.log('   currentPaymentType definido como:', currentPaymentType);
        
        submitContainer.classList.remove('hidden');
        console.log('   Submit container mostrado');
        
        submitText.textContent = 'Gerar QR Code PIX';
        console.log('   Texto do botão alterado para:', submitText.textContent);
        
        hideStatus();
        console.log('✅ PIX CHECKOUT CONFIGURADO COM SUCESSO');
        
    } catch (error) {
        console.error('❌ ERRO ao configurar PIX:', error);
        console.error('   Stack trace:', error.stack);
        showStatus('error', 'Erro no PIX', 'Não foi possível configurar o pagamento PIX');
    }
}

// Função para configurar checkout com cartão
async function setupCardCheckout() {
    try {
        hideStatus();
        showStatus('loading', 'Configurando cartão...', 'Preparando pagamento com cartão de crédito');
        
        // Para cartão, mostrar opção de redirecionamento
        elementsContainer.innerHTML = `
            <div class="text-center">
                <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                    <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-green-800 mb-2">Cartão de Crédito</h3>
                    <p class="text-green-600 mb-4">Clique no botão abaixo para ir ao Mercado Pago</p>
                    <p class="text-sm text-gray-500">Redirecionamento para página de pagamento</p>
                    <p class="text-xs text-green-600 mt-2">✅ Página oficial do Mercado Pago</p>
                </div>
            </div>
        `;
        
        currentPaymentType = 'card';
        submitContainer.classList.remove('hidden');
        submitText.textContent = 'Ir para Mercado Pago';
        hideStatus();
        
    } catch (error) {
        console.error('Erro ao configurar cartão:', error);
        showStatus('error', 'Erro no cartão', 'Não foi possível configurar o pagamento com cartão');
    }
}

// Event listeners para opções de pagamento
console.log('🔗 CONFIGURANDO EVENT LISTENERS DAS OPÇÕES DE PAGAMENTO');
const paymentOptions = document.querySelectorAll('.payment-option');
console.log(`📱 Encontradas ${paymentOptions.length} opções de pagamento`);

paymentOptions.forEach((option, index) => {
    console.log(`   Opção ${index + 1}:`, option.dataset.type, option);
    
    option.addEventListener('click', async (event) => {
        console.log('🖱️ OPÇÃO DE PAGAMENTO CLICADA');
        console.log('   Evento:', event);
        console.log('   Elemento clicado:', option);
        console.log('   Tipo:', option.dataset.type);
        
        const type = option.dataset.type;
        
        // Limpar elementos anteriores
        console.log('🧹 Limpando elementos anteriores...');
        elementsContainer.innerHTML = '';
        submitContainer.classList.add('hidden');
        console.log('   Elements container limpo');
        console.log('   Submit container escondido');
        
        if (type === 'pix') {
            console.log('🔵 PIX selecionado - chamando setupPixCheckout()');
            await setupPixCheckout();
        } else if (type === 'card') {
            console.log('🟢 CARTÃO selecionado - chamando setupCardCheckout()');
            await setupCardCheckout();
        } else {
            console.log('❌ Tipo de pagamento desconhecido:', type);
        }
    });
    
    console.log(`✅ Event listener adicionado à opção ${index + 1}`);
});

console.log('🎯 Event listeners configurados com sucesso');

// Event listener para botão de pagamento
submitButton.addEventListener('click', async () => {
    if (!currentPaymentType) {
        showStatus('error', 'Selecione uma opção', 'Escolha PIX ou cartão para continuar');
        return;
    }
    
    submitButton.disabled = true;
    submitText.classList.add('hidden');
    loadingSpinner.classList.remove('hidden');
    
    try {
        if (currentPaymentType === 'pix') {
            // Para PIX, SEMPRE gerar QR Code diretamente no modal
            console.log('🔵 PIX SELECIONADO - INICIANDO GERAÇÃO DIRETA');
            console.log('   Payment ID:', PAYMENT_ID);
            console.log('   Current Payment Type:', currentPaymentType);
            console.log('   Submit Button:', submitButton);
            console.log('   Submit Text:', submitText);
            console.log('   Loading Spinner:', loadingSpinner);
            
            // FORÇAR PIX DIRETO - NÃO REDIRECIONAR PARA MERCADO PAGO
            console.log('🚫 BLOQUEANDO REDIRECIONAMENTO PARA MERCADO PAGO');
            console.log('✅ USANDO PIX DIRETO - SEM REDIRECIONAMENTO');
            
            showStatus('loading', 'Gerando PIX...', 'Aguarde, estamos gerando seu código PIX');
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            console.log('🔐 CSRF Token:', csrfToken ? 'Encontrado' : 'NÃO ENCONTRADO');
            if (csrfToken) {
                console.log('   Token value:', csrfToken.value.substring(0, 20) + '...');
            }
            
            const url = `/payments/gerar-pix/{{ pagamento.id }}/`;
            console.log('🌐 URL da API PIX:', url);
            
            const requestOptions = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken ? csrfToken.value : ''
                }
            };
            
            console.log('📤 Enviando requisição PIX:', requestOptions);
            
            fetch(url, requestOptions)
            .then(response => {
                console.log('📥 Resposta recebida da API PIX:');
                console.log('   Status:', response.status);
                console.log('   Status Text:', response.statusText);
                console.log('   Headers:', response.headers);
                console.log('   OK:', response.ok);
                
                if (!response.ok) {
                    console.error('❌ Resposta não OK:', response.status, response.statusText);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('📊 Dados recebidos da API PIX:');
                console.log('   Success:', data.success);
                console.log('   Error:', data.error);
                console.log('   Payment ID:', data.payment_id);
                console.log('   Status:', data.status);
                console.log('   QR Code:', data.qr_code ? data.qr_code.substring(0, 50) + '...' : 'None');
                console.log('   QR Code Base64:', data.qr_code_base64 ? data.qr_code_base64.substring(0, 50) + '...' : 'None');
                console.log('   Dados completos:', data);
                
                if (data.success) {
                    // PIX gerado com sucesso, mostrar QR Code no modal
                    console.log('✅ PIX GERADO COM SUCESSO!');
                    console.log('   Mostrando modal PIX...');
                    showPixQRCode(data);
                } else {
                    // Erro ao gerar PIX, mostrar erro
                    console.error('❌ ERRO AO GERAR PIX:', data.error);
                    console.error('   Detalhes:', data.details);
                    showStatus('error', 'Erro no PIX', data.error || 'Erro ao gerar PIX. Tente novamente ou use cartão de crédito.');
                    
                    // Reabilitar botão para tentar novamente
                    submitButton.disabled = false;
                    submitText.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    console.log('🔄 Botão reabilitado para nova tentativa');
                }
            })
            .catch(error => {
                console.error('❌ ERRO DE CONEXÃO AO GERAR PIX:');
                console.error('   Error:', error);
                console.error('   Message:', error.message);
                console.error('   Stack:', error.stack);
                showStatus('error', 'Erro no PIX', 'Erro de conexão. Tente novamente ou use cartão de crédito.');
                
                // Reabilitar botão para tentar novamente
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                console.log('🔄 Botão reabilitado após erro de conexão');
            });
            
        } else if (currentPaymentType === 'card') {
            // Para cartão, SEMPRE redirecionar para Mercado Pago
            console.log('Redirecionando para Mercado Pago (cartão)...');
            showStatus('loading', 'Redirecionando...', 'Aguarde, estamos redirecionando para o pagamento');
            
            console.log('🔗 Dados de redirecionamento:');
            console.log('   PREFERENCE_ID:', PREFERENCE_ID);
            console.log('   PUBLIC_KEY:', PUBLIC_KEY);
            
            if (PREFERENCE_ID && PREFERENCE_ID !== 'None' && PREFERENCE_ID !== '') {
                console.log('✅ Redirecionando para Mercado Pago com preference_id:', PREFERENCE_ID);
                
                // URL correta para sandbox/produção
                const checkoutUrl = `https://www.mercadopago.com.br/checkout/v1/redirect?pref_id=${PREFERENCE_ID}`;
                console.log('🔗 URL de checkout:', checkoutUrl);
                
                setTimeout(() => {
                    window.location.href = checkoutUrl;
                }, 1000);
            } else {
                console.error('❌ PREFERENCE_ID não encontrado ou inválido:', PREFERENCE_ID);
                showStatus('error', 'Erro no pagamento', 'ID de preferência não encontrado. Tente novamente.');
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }
        
    } catch (error) {
        console.error('Erro no pagamento:', error);
        showStatus('error', 'Erro no pagamento', 'Ocorreu um erro ao processar o pagamento');
        submitButton.disabled = false;
        submitText.classList.remove('hidden');
        loadingSpinner.classList.add('hidden');
    }
});

// Função para verificar status do pagamento
async function checkPaymentStatus() {
    try {
        const response = await fetch(`/payments/verificar-status/${PAYMENT_ID}/`);
        const data = await response.json();
        
        if (data.status === 'approved') {
            showStatus('success', 'Pagamento aprovado!', 'Sua assinatura foi ativada');
            setTimeout(() => {
                window.location.href = '{% url "payments:sucesso" %}';
            }, 2000);
        } else if (data.status === 'rejected') {
            showStatus('error', 'Pagamento rejeitado', 'Verifique os dados e tente novamente');
        } else if (data.status === 'pending') {
            showStatus('loading', 'Pagamento pendente', 'Aguardando confirmação');
        }
    } catch (error) {
        console.error('Erro ao verificar status:', error);
    }
}

// Verificar status a cada 5 segundos (para pagamentos PIX)
setInterval(checkPaymentStatus, 5000);

// Função de teste para modal PIX
function testPixModal() {
    console.log('Testando modal PIX...');
    const testData = {
        success: true,
        qr_code_base64: 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
        payment_id: '123456789'
    };
    showPixQRCode(testData);
}

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 CHECKOUT INICIALIZADO');
    console.log('📊 Configurações:');
    console.log('   Public Key:', PUBLIC_KEY);
    console.log('   Preference ID:', PREFERENCE_ID);
    console.log('   Payment ID:', PAYMENT_ID);
    console.log('   PIX Available:', PIX_AVAILABLE);
    console.log('   Init Point:', INIT_POINT);
    
    // Verificar elementos do DOM
    console.log('🔍 Elementos do DOM:');
    console.log('   Elements Container:', document.getElementById('mercadopago-elements'));
    console.log('   Submit Container:', document.getElementById('submit-container'));
    console.log('   Submit Button:', document.getElementById('submit-payment'));
    console.log('   Payment Options:', document.querySelectorAll('.payment-option'));
    
    // Verificar opções de pagamento
    const paymentOptions = document.querySelectorAll('.payment-option');
    console.log(`📱 Opções de pagamento encontradas: ${paymentOptions.length}`);
    paymentOptions.forEach((option, index) => {
        console.log(`   Opção ${index + 1}:`, option.dataset.type, option);
    });
    
    // Verificar se PIX está disponível
    if (PIX_AVAILABLE) {
        console.log('✅ PIX está disponível na configuração');
    } else {
        console.log('❌ PIX NÃO está disponível na configuração');
    }
    
    // Adicionar botão de teste (remover em produção)
    const testButton = document.createElement('button');
    testButton.textContent = 'Testar Modal PIX';
    testButton.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg z-50';
    testButton.onclick = testPixModal;
    document.body.appendChild(testButton);
    
    console.log('🎯 Checkout pronto para uso!');
});
</script>

<!-- Header com navegação -->
<header class="bg-white shadow-sm border-b border-gray-200 mb-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <div class="flex items-center">
                <a href="{% url 'index' %}" class="flex items-center space-x-2">
                    <img src="{% static 'judo.png' %}" alt="Judo" class="h-8 w-8">
                    <span class="text-xl font-bold text-gray-800">Academia de Judô</span>
                </a>
            </div>
            <div class="flex items-center space-x-4">
                {% if user.is_authenticated %}
                    <span class="text-sm text-gray-600">Olá, {{ user.first_name|default:user.username }}</span>
                    <form method="post" action="{% url 'logout' %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            Logout
                        </button>
                    </form>
                {% else %}
                    <a href="{% url 'login' %}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Login
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</header>

<!-- Messages -->
{% if messages %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} bg-{% if message.tags == 'error' %}red{% elif message.tags == 'warning' %}yellow{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-100 border border-{% if message.tags == 'error' %}red{% elif message.tags == 'warning' %}yellow{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-400 text-{% if message.tags == 'error' %}red{% elif message.tags == 'warning' %}yellow{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-700 px-4 py-3 rounded mb-4">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

</body>
</html>
