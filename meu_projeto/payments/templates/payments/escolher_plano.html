{% extends 'base.html' %}
{% load static %}

{% block title %}Escolher Plano - {{ plano.nome }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Escolha seu Plano</h1>
        <p class="text-gray-600">Complete seus dados para finalizar a assinatura</p>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
        <!-- Formulário de Dados -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Seus Dados</h2>
            
            <form id="payment-form" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" name="plano_id" value="{{ plano.id }}">
                
                <div>
                    <label for="nome" class="block text-sm font-medium text-gray-700 mb-2">
                        Nome Completo *
                    </label>
                    <input type="text" id="nome" name="nome" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           value="{% if user.profile %}{{ user.profile.nome }}{% else %}{{ user.get_full_name }}{% endif %}"
                           placeholder="Digite seu nome completo">
                </div>
                
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                        E-mail *
                    </label>
                    <input type="email" id="email" name="email" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           value="{{ user.email }}"
                           placeholder="seu@email.com">
                </div>
                
                <div>
                    <label for="telefone" class="block text-sm font-medium text-gray-700 mb-2">
                        Telefone
                    </label>
                    <input type="tel" id="telefone" name="telefone"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="(11) 99999-9999">
                </div>
                
                <div>
                    <label for="cpf" class="block text-sm font-medium text-gray-700 mb-2">
                        CPF
                    </label>
                    <input type="text" id="cpf" name="cpf"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="000.000.000-00">
                </div>
                
                <div class="pt-4">
                    <button type="submit" id="submit-form"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="submit-text">Continuar para Pagamento</span>
                        <div id="loading-spinner" class="hidden">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Processando...
                        </div>
                    </button>
                </div>
            </form>
        </div>

        <!-- Resumo do Plano -->
        <div class="space-y-6">
            <!-- Detalhes do Plano -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg shadow-lg p-6 text-white">
                <h2 class="text-2xl font-bold mb-4">{{ plano.nome }}</h2>
                <div class="text-4xl font-bold mb-2">R$ {{ plano.preco|floatformat:2 }}</div>
                <div class="text-blue-100 mb-4">{{ plano.duracao_dias }} dias de acesso</div>
                <p class="text-blue-100">{{ plano.descricao }}</p>
            </div>

            <!-- Benefícios -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">O que você ganha:</h3>
                <ul class="space-y-3">
                    <li class="flex items-center">
                        <svg class="w-6 h-6 text-green-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-gray-700">Acesso completo ao quiz ilimitado</span>
                    </li>
                    <li class="flex items-center">
                        <svg class="w-6 h-6 text-green-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-gray-700">Progresso detalhado e estatísticas</span>
                    </li>
                    <li class="flex items-center">
                        <svg class="w-6 h-6 text-green-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-gray-700">Relatórios avançados de desempenho</span>
                    </li>
                    {% if plano.nome == 'Plano Anual' %}
                    <li class="flex items-center">
                        <svg class="w-6 h-6 text-green-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-gray-700">Suporte prioritário</span>
                    </li>
                    {% endif %}
                </ul>
            </div>

            <!-- Segurança -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <div class="flex items-center text-gray-600">
                    <svg class="w-6 h-6 text-green-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                    </svg>
                    <div>
                        <div class="font-medium text-gray-800">Pagamento 100% seguro</div>
                        <div class="text-sm text-gray-600">Processado pelo Mercado Pago</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="status-message" class="hidden mt-6">
        <div id="status-content" class="rounded-lg p-4">
            <div class="flex items-center">
                <div id="status-icon" class="w-6 h-6 mr-3"></div>
                <div>
                    <h4 id="status-title" class="font-medium"></h4>
                    <p id="status-text" class="text-sm"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Elementos do DOM
const form = document.getElementById('payment-form');
const submitButton = document.getElementById('submit-form');
const submitText = document.getElementById('submit-text');
const loadingSpinner = document.getElementById('loading-spinner');
const statusMessage = document.getElementById('status-message');
const statusContent = document.getElementById('status-content');
const statusIcon = document.getElementById('status-icon');
const statusTitle = document.getElementById('status-title');
const statusText = document.getElementById('status-text');

// Função para mostrar status
function showStatus(type, title, message) {
    statusIcon.innerHTML = '';
    
    if (type === 'success') {
        statusIcon.innerHTML = '<svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
        statusContent.className = 'bg-green-50 border border-green-200 text-green-700 rounded-lg p-4';
    } else if (type === 'error') {
        statusIcon.innerHTML = '<svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
        statusContent.className = 'bg-red-50 border border-red-200 text-red-700 rounded-lg p-4';
    } else {
        statusIcon.innerHTML = '<svg class="w-6 h-6 text-blue-500 animate-spin" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>';
        statusContent.className = 'bg-blue-50 border border-blue-200 text-blue-700 rounded-lg p-4';
    }
    
    statusTitle.textContent = title;
    statusText.textContent = message;
    statusMessage.classList.remove('hidden');
}

// Função para esconder status
function hideStatus() {
    statusMessage.classList.add('hidden');
}

// Função para formatar CPF
function formatCPF(cpf) {
    return cpf.replace(/\D/g, '').replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
}

// Função para formatar telefone
function formatPhone(phone) {
    return phone.replace(/\D/g, '').replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
}

// Event listeners para formatação
document.getElementById('cpf').addEventListener('input', function(e) {
    e.target.value = formatCPF(e.target.value);
});

document.getElementById('telefone').addEventListener('input', function(e) {
    e.target.value = formatPhone(e.target.value);
});

// Event listener para envio do formulário
form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Desabilitar botão e mostrar loading
    submitButton.disabled = true;
    submitText.classList.add('hidden');
    loadingSpinner.classList.remove('hidden');
    hideStatus();
    
    try {
        // Coletar dados do formulário
        const formData = new FormData(form);
        
        // Enviar requisição para criar pagamento
        const response = await fetch('{% url "payments:criar_pagamento" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showStatus('success', 'Pagamento criado!', 'Redirecionando para o checkout...');
            
            // Redirecionar para checkout após 1 segundo
            setTimeout(() => {
                window.location.href = `{% url "payments:checkout_pagamento" 0 %}`.replace('0', data.payment_id);
            }, 1000);
            
        } else {
            showStatus('error', 'Erro ao criar pagamento', data.error || 'Tente novamente');
            submitButton.disabled = false;
            submitText.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
        }
        
    } catch (error) {
        console.error('Erro:', error);
        showStatus('error', 'Erro de conexão', 'Verifique sua internet e tente novamente');
        submitButton.disabled = false;
        submitText.classList.remove('hidden');
        loadingSpinner.classList.add('hidden');
    }
});

// Validação em tempo real
document.getElementById('email').addEventListener('blur', function(e) {
    const email = e.target.value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (email && !emailRegex.test(email)) {
        e.target.classList.add('border-red-500');
        e.target.classList.remove('border-gray-300');
    } else {
        e.target.classList.remove('border-red-500');
        e.target.classList.add('border-gray-300');
    }
});
</script>
{% endblock %}
